# 权限系统实现教程

## 1. 权限验证基础

### 1.1 权限验证方法
```typescript
// src/utils/permission.ts
export function hasPermission(roles: string[], route: RouteRecordRaw): boolean {
  if (route.meta?.roles) {
    return roles.some(role => route.meta.roles.includes(role))
  }
  return true
}
```

### 1.2 路由过滤实现
```typescript
export function filterAsyncRoutes(
  routes: RouteRecordRaw[],
  roles: string[]
): RouteRecordRaw[] {
  return routes.filter(route => {
    if (hasPermission(roles, route)) {
      if (route.children) {
        route.children = filterAsyncRoutes(route.children, roles)
      }
      return true
    }
    return false
  })
}
```

## 2. 动态权限管理

### 2.1 权限Store实现
```typescript
// src/store/modules/permission.ts
export const usePermissionStore = defineStore('permission', {
  state: () => ({
    routes: [] as RouteRecordRaw[],
    addRoutes: [] as RouteRecordRaw[]
  }),
  actions: {
    generateRoutes(roles: string[]): Promise<RouteRecordRaw[]> {
      return new Promise(resolve => {
        let accessedRoutes
        if (roles.includes('admin')) {
          accessedRoutes = asyncRoutes || []
        } else {
          accessedRoutes = filterAsyncRoutes(asyncRoutes, roles)
        }
        this.addRoutes = accessedRoutes
        this.routes = constantRoutes.concat(accessedRoutes)
        resolve(accessedRoutes)
      })
    }
  }
})
```

### 2.2 按钮权限指令
```typescript
// src/directives/permission.ts
export const permission = {
  mounted(el, binding) {
    const { value } = binding
    const roles = useUserStore().roles
    if (value && !hasPermission(roles, { meta: { roles: value } })) {
      el.parentNode?.removeChild(el)
    }
  }
}
```

## 3. 权限集成

### 3.1 路由守卫集成
```typescript
// src/permission.ts
router.beforeEach(async (to, from, next) => {
  // ...其他逻辑
  const accessRoutes = await store.dispatch('permission/generateRoutes', roles)
  accessRoutes.forEach(route => router.addRoute(route))
  next({ ...to, replace: true })
})
```

### 3.2 按钮权限使用
```vue
<template>
  <el-button v-permission="['admin']">删除</el-button>
</template>
```

## 4. 最佳实践

1. **角色管理**：在后台维护角色权限映射
2. **权限缓存**：缓存用户权限数据
3. **错误处理**：完善的权限错误提示
4. **测试覆盖**：单元测试验证权限逻辑

## 5. 常见问题

### 5.1 权限变更不生效
解决方案：重新登录获取最新权限

### 5.2 按钮权限失效
检查点：
1. 指令是否正确注册
2. 角色数据是否正确
3. 权限验证逻辑