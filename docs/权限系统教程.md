# 权限系统详细教程

## 1. 功能概述
- 基于角色的访问控制(RBAC)
- 动态路由加载机制
- 按钮级权限控制
- 权限验证流程

## 2. 核心代码解析

### 2.1 权限验证方法
```typescript
// src/utils/routers.ts
export function hasPermission(roles: string[], route: RouteRecordRaw): boolean {
  if (route.meta?.roles) {
    return roles.some(role => route.meta.roles.includes(role))
  }
  return true
}
```

### 2.2 路由过滤算法
```typescript
// src/utils/routers.ts
export function filterAsyncRoutes(
  routes: RouteRecordRaw[],
  roles: string[]
): RouteRecordRaw[] {
  return routes.filter(route => {
    if (hasPermission(roles, route)) {
      if (route.children) {
        route.children = filterAsyncRoutes(route.children, roles)
      }
      return true
    }
    return false
  })
}
```

### 2.3 动态路由生成
```typescript
// src/store/modules/permission.ts
generateRoutes(roles: string[]): Promise<RouteRecordRaw[]> {
  return new Promise(resolve => {
    let accessedRoutes: RouteRecordRaw[]
    if (roles.includes('admin')) {
      accessedRoutes = asyncRoutes || []
    } else {
      accessedRoutes = filterAsyncRoutes(asyncRoutes, roles)
    }
    accessedRoutes.push(notFoundRoute)
    this.routes = constantRoutes.concat(accessedRoutes)
    resolve(accessedRoutes)
  })
}
```

## 3. 使用示例

### 3.1 路由配置
```typescript
{
  path: '/system',
  component: Layout,
  meta: {
    title: '系统管理',
    roles: ['admin', 'editor'] // 可访问角色
  },
  children: [
    {
      path: 'user',
      component: () => import('@/views/system/user'),
      meta: { title: '用户管理' }
    }
  ]
}
```

### 3.2 按钮权限控制
```vue
<template>
  <el-button 
    v-if="hasPermission(['admin'])" 
    @click="handleDelete">
    删除
  </el-button>
</template>

<script setup>
import { usePermission } from '@/hooks/usePermission'

const { hasPermission } = usePermission()
</script>
```

## 4. 最佳实践
1. 角色定义清晰明确
2. 路由meta信息规范统一
3. 权限验证逻辑复用
4. 错误处理完善

## 5. 常见问题
Q: 新增角色后权限不生效？
A: 需要重新登录获取最新角色信息

Q: 动态路由加载失败？
A: 检查路由配置的roles字段是否正确